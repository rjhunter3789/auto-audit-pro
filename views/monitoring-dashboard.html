<!--
  Auto Audit Pro
  Â© 2025 JL Robinson. All Rights Reserved.
  
  This file contains proprietary code for the Auto Audit Pro platform.
  Unauthorized use, reproduction, or distribution is prohibited.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Monitoring Dashboard - Auto Audit Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #2c3e50;
            --success-color: #22c55e;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
        }

        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* Remove old dashboard-header styles */

        .dashboard-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }

        .dashboard-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Status Cards */
        .status-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            height: 100%;
        }

        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .status-card.status-green {
            border-left: 5px solid var(--success-color);
        }

        .status-card.status-yellow {
            border-left: 5px solid var(--warning-color);
        }

        .status-card.status-red {
            border-left: 5px solid var(--danger-color);
        }

        .status-card.status-unknown {
            border-left: 5px solid #6c757d;
        }

        .status-card.status-pending {
            border-left: 5px solid #ffc107;
            background-color: #fffbf0;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
            animation: pulse 2s infinite;
        }

        .status-indicator.green {
            background-color: var(--success-color);
        }

        .status-indicator.yellow {
            background-color: var(--warning-color);
        }

        .status-indicator.red {
            background-color: var(--danger-color);
        }

        .status-indicator.unknown {
            background-color: #6c757d;
        }

        .status-indicator.pending {
            background-color: #ffc107;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* Summary Stats */
        .stat-box {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Alert Table */
        .alert-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden;
            max-height: 500px;
            overflow-y: auto;
        }

        .alert-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .alert-badge.red {
            background-color: #fecaca;
            color: #dc2626;
        }

        .alert-badge.yellow {
            background-color: #fef3c7;
            color: #d97706;
        }

        /* Action Buttons */
        .btn-monitor {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 5px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-monitor:hover {
            background-color: #357abd;
            color: white;
        }

        /* Loading Animation */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.active {
            display: block;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Modal Styles */
        .modal-header {
            background-color: var(--light-bg);
            border-bottom: 1px solid #dee2e6;
        }
        
        /* Navigation Bar */
        .suite-nav {
            background: var(--dark-bg);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .suite-nav .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suite-brand {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            text-decoration: none;
        }

        .suite-brand:hover {
            color: #E5E7EB;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            margin: 0;
        }

        .nav-links a {
            color: #9CA3AF;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: white;
        }

        /* Anti-LastPass Styles */
        #sms_notification_contact,
        input[name="emergency_contact_sms"] {
            background-image: none !important;
            background-attachment: none !important;
            background-color: white !important;
            -webkit-appearance: none !important;
            padding-right: 40px !important;
        }
        
        #sms_notification_contact:focus {
            background-image: none !important;
            background-color: white !important;
        }
        
        /* Aggressive LastPass prevention for ALL form inputs in modal */
        #addProfileModal input[type="text"],
        #addProfileModal input[type="email"],
        #addProfileModal input[type="tel"],
        #addProfileModal input[type="url"],
        #addProfileModal input.form-control,
        #dealerName,
        #websiteUrl,
        #contactEmail,
        #alertEmail,
        #sms_notification_contact {
            background-image: none !important;
            background-attachment: none !important;
            background-color: white !important;
            background-position: 0 0 !important;
            background-size: auto !important;
            background-repeat: no-repeat !important;
            background-origin: padding-box !important;
            background-clip: border-box !important;
            padding-right: 12px !important;
            -webkit-appearance: none !important;
        }
        
        /* Hide any LastPass elements globally */
        [id*="__lpform"],
        [class*="lastpass"],
        [data-lastpass],
        [data-lastpass-icon-root],
        div[style*="lastpass"],
        #addProfileModal [id*="lastpass"],
        #addProfileModal [class*="lastpass"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            width: 0 !important;
            height: 0 !important;
            position: absolute !important;
            left: -9999px !important;
            pointer-events: none !important;
        }
        
        /* Hide any LastPass elements */
        [id*="__lpform"],
        [class*="lastpass"],
        [data-lastpass],
        div[style*="lastpass"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            width: 0 !important;
            height: 0 !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="suite-nav">
        <div class="container">
            <a href="/" class="suite-brand">Auto Audit Pro Suite</a>
            <div class="nav-links">
                <a href="/website-audit">Website Analysis</a>
                <a href="/lead-analysis">Lead Performance</a>
                <a href="/monitoring" class="active">Monitoring</a>
                <a href="/definitions">Definitions</a>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="container mt-4">
        <div class="row align-items-center mb-4">
            <div class="col-lg-8 col-md-12">
                <h1 class="mb-2">Website Monitoring Dashboard</h1>
                <p class="text-muted mb-0">Real-time website health monitoring - Your digital "Check Engine" light</p>
            </div>
            <div class="col-lg-4 col-md-12">
                <div class="d-flex justify-content-lg-end justify-content-start gap-2 flex-wrap">
                    <a href="/admin-settings-direct" class="btn btn-primary btn-sm" id="adminSettingsBtn">
                        <i class="bi bi-gear"></i> Admin
                    </a>
                    <button class="btn btn-primary btn-sm" onclick="showAddProfileModal()" id="addWebsiteBtn">
                        <i class="bi bi-plus-circle"></i> Add Website
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="exportReport()" title="Export">
                        <i class="bi bi-download"></i>
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="refreshDashboard()" title="Refresh">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Summary Stats -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-box">
                    <div class="stat-number text-primary" id="totalAlerts">0</div>
                    <div class="stat-label">Active Alerts</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-box">
                    <div class="stat-number text-success" id="resolvedAlerts">0</div>
                    <div class="stat-label">Resolved</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-box">
                    <div class="stat-number text-warning" id="yellowAlerts">0</div>
                    <div class="stat-label">Warnings</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-box">
                    <div class="stat-number text-danger" id="redAlerts">0</div>
                    <div class="stat-label">Critical</div>
                </div>
            </div>
        </div>

        <!-- API Usage Stats -->
        <div class="row mb-4" id="apiStatsSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> ScrapingDog API Usage</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number text-info" id="scrapingDogRequests">0</div>
                                    <div class="stat-label">API Requests</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number text-success" id="scrapingDogSuccess">0%</div>
                                    <div class="stat-label">Success Rate</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number text-primary" id="scrapingDogCost">$0.00</div>
                                    <div class="stat-label">Estimated Cost</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-box">
                                    <div class="stat-number text-warning" id="scrapingDogUsage">0%</div>
                                    <div class="stat-label">API Usage Rate</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Alerts -->
        <div class="mb-4">
            <h3><i class="bi bi-exclamation-triangle"></i> Active Alerts</h3>
            <div class="alert-table">
                <div class="loading" id="alertsLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="alertsList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Monitored Websites -->
        <div class="mb-5">
            <h3><i class="bi bi-globe"></i> Monitored Websites</h3>
            <div class="loading active" id="sitesLoading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="row" id="sitesList"></div>
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="bi bi-inbox"></i>
                <h4>No websites monitored yet</h4>
                <p>Add your first website to start monitoring</p>
                <button class="btn btn-monitor" onclick="showAddProfileModal()">
                    <i class="bi bi-plus-circle"></i> Add Website
                </button>
            </div>
        </div>
    </div>

    <!-- Add Profile Modal -->
    <div class="modal fade" id="addProfileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Website to Monitor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addProfileForm">
                        <div class="mb-3">
                            <label class="form-label">Dealership Name</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="dealerName"
                                   name="monitoring_dealer_title"
                                   placeholder="Enter dealership name"
                                   autocomplete="nope"
                                   data-lpignore="true"
                                   data-form-type="other"
                                   required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Website URL</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="websiteUrl" 
                                   name="monitoring_site_address"
                                   placeholder="https://example.com"
                                   pattern="https?://.+"
                                   autocomplete="nope"
                                   data-lpignore="true"
                                   data-form-type="other"
                                   required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contact Email</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="contactEmail" 
                                   name="monitoring_contact_address"
                                   placeholder="your@email.com"
                                   pattern="[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}"
                                   autocomplete="nope"
                                   data-lpignore="true"
                                   data-form-type="other"
                                   required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Alert Email (optional)</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="alertEmail" 
                                   name="monitoring_alert_address"
                                   placeholder="Leave blank to use contact email"
                                   pattern="[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}"
                                   autocomplete="nope"
                                   data-lpignore="true"
                                   data-form-type="other">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-monitor" onclick="addProfile()" id="submitBtn">Add Website</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let profiles = [];
        let activeAlerts = [];
        let currentUser = null;

        // Configure axios to include credentials
        axios.defaults.withCredentials = true;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadDashboard();
            // Refresh every 60 seconds
            setInterval(loadDashboard, 60000);
            
            // Comprehensive LastPass removal for ALL form fields
            function cleanAllFormFields() {
                // Remove ALL LastPass elements
                document.querySelectorAll('[id*="__lpform"], [class*="lastpass"], [data-lastpass], [data-lastpass-icon-root]').forEach(el => {
                    el.remove();
                });
                
                // Clean ALL input fields in the modal
                const allInputs = document.querySelectorAll('#addProfileModal input[type="text"], #addProfileModal input[type="email"], #addProfileModal input[type="tel"], #addProfileModal input[type="url"]');
                allInputs.forEach(input => {
                    // Force clean styling
                    input.style.cssText = 'background-image: none !important; background-attachment: none !important; background-color: white !important; padding-right: 12px !important;';
                    
                    // Add multiple anti-LastPass attributes
                    input.setAttribute('data-lpignore', 'true');
                    input.setAttribute('data-form-type', 'other');
                    input.setAttribute('data-lastpass-ignore', 'true');
                    
                    // Remove any injected attributes
                    Array.from(input.attributes).forEach(attr => {
                        if (attr.name.toLowerCase().includes('lastpass') || attr.name.toLowerCase().includes('lpform')) {
                            input.removeAttribute(attr.name);
                        }
                    });
                });
                
                // Also clean any parent containers that might have been modified
                document.querySelectorAll('#addProfileModal .form-control').forEach(el => {
                    const parent = el.parentElement;
                    if (parent) {
                        parent.style.position = 'relative';
                        // Remove any injected siblings
                        Array.from(parent.children).forEach(child => {
                            if (child !== el && (child.id?.includes('lastpass') || child.className?.includes('lastpass'))) {
                                child.remove();
                            }
                        });
                    }
                });
            }
            
            // Run more aggressively when modal is shown
            document.getElementById('addProfileModal').addEventListener('shown.bs.modal', function() {
                cleanAllFormFields();
                // Run multiple times after modal opens
                setTimeout(cleanAllFormFields, 100);
                setTimeout(cleanAllFormFields, 300);
                setTimeout(cleanAllFormFields, 500);
                setTimeout(cleanAllFormFields, 1000);
            });
            
            // Run once after a short delay
            setTimeout(cleanAllFormFields, 500);
            
            // Run periodically but less frequently
            const cleanInterval = setInterval(cleanAllFormFields, 2000);
            
            // Stop after 20 seconds
            setTimeout(() => {
                clearInterval(cleanInterval);
            }, 20000);
            
            // Also add a MutationObserver to catch any new injections
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            if (node.id?.includes('lastpass') || node.className?.includes('lastpass') || node.hasAttribute('data-lastpass')) {
                                node.remove();
                            }
                        }
                    });
                });
            });
            
            // Observe the modal for changes
            const modalElement = document.getElementById('addProfileModal');
            if (modalElement) {
                observer.observe(modalElement, { childList: true, subtree: true });
            }
        });

        async function loadUserInfo() {
            // TEMPORARILY BYPASSED - Treat everyone as admin
            console.log('Auth BYPASSED - Setting user as admin');
            currentUser = {
                username: 'admin',
                role: 'admin',
                isAdmin: true,
                dealership: null
            };
            updateUIForRole();
        }

        function updateUIForRole() {
            if (!currentUser) return;
            
            // Show/hide admin controls based on user role
            const adminSettingsBtn = document.getElementById('adminSettingsBtn');
            if (adminSettingsBtn) {
                if (currentUser.isAdmin) {
                    // Show admin button for admin users
                    adminSettingsBtn.style.display = '';
                } else {
                    // Hide admin button for non-admin users
                    adminSettingsBtn.style.display = 'none';
                }
            }
            
            // Additional UI changes for non-admin users
            if (!currentUser.isAdmin) {
                
                // Change "Add Website" to "Request Website Monitoring" for dealers
                const addWebsiteText = document.getElementById('addWebsiteText');
                if (addWebsiteText) {
                    addWebsiteText.textContent = 'Request Monitoring';
                }
                
                // Update modal title for dealers
                const modalTitle = document.getElementById('modalTitle');
                if (modalTitle) {
                    modalTitle.textContent = 'Request Website Monitoring';
                }
                
                // Update submit button text for dealers
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.textContent = 'Submit Request';
                }
                
                // Hide frequency selector in add modal
                // Check frequency is now admin-controlled only
                if (frequencyDiv) {
                    frequencyDiv.style.display = 'none';
                }
                
                // Hide delete buttons
                document.querySelectorAll('.btn-outline-danger').forEach(btn => {
                    if (btn.innerHTML.includes('bi-trash')) {
                        btn.style.display = 'none';
                    }
                });
                
                // Hide settings that should be admin-only
                // We'll add more restrictions as needed
            }
            
            // Show admin features if admin
            if (currentUser.isAdmin) {
                const header = document.querySelector('.dashboard-header h1');
                if (header && !header.innerHTML.includes('Admin')) {
                    header.innerHTML += ' <span class="badge bg-danger ms-2">Admin</span>';
                }
                
                // Show admin settings button
                const adminBtn = document.getElementById('adminSettingsBtn');
                if (adminBtn) {
                    adminBtn.style.display = 'inline-block';
                }
            }
        }

        async function loadDashboard() {
            try {
                // Load monitoring status
                const statusResponse = await axios.get('/api/monitoring/status');
                profiles = statusResponse.data;
                
                // Debug logging
                console.log('Received profiles from API:', profiles.length, profiles.map(p => ({ id: p.id, name: p.dealer_name })));
                
                // Remove any duplicates based on ID
                const uniqueProfiles = [];
                const seenIds = new Set();
                
                profiles.forEach(profile => {
                    if (!seenIds.has(profile.id)) {
                        seenIds.add(profile.id);
                        uniqueProfiles.push(profile);
                    } else {
                        console.warn('Duplicate profile detected:', profile.id, profile.dealer_name);
                    }
                });
                
                profiles = uniqueProfiles;
                console.log('After deduplication:', profiles.length, 'profiles');
                
                // Don't update stats here - wait until alerts are loaded
                renderSites();
                
                // Load active alerts - this will update stats
                await loadActiveAlerts();
                
                // Load API usage stats
                await loadApiStats();
                
                // Reapply role-based UI updates
                updateUIForRole();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                if (error.response) {
                    console.error('Response status:', error.response.status);
                    console.error('Response data:', error.response.data);
                    
                    if (error.response.status === 401) {
                        alert('Session expired. Please login again.');
                        window.location.href = '/login';
                    } else if (error.response.status === 403) {
                        // Don't show alert for 403 errors - just log them
                        console.warn('403 error but continuing - likely a route ordering issue');
                    }
                }
            }
        }

        async function loadApiStats() {
            try {
                const response = await axios.get('/api/monitoring/stats');
                const stats = response.data;
                
                if (stats.scrapingDogStats && stats.scrapingDogStats.totalRequests > 0) {
                    // Show the API stats section
                    document.getElementById('apiStatsSection').style.display = 'block';
                    
                    // Update the stats
                    document.getElementById('scrapingDogRequests').textContent = stats.scrapingDogStats.totalRequests;
                    document.getElementById('scrapingDogSuccess').textContent = stats.scrapingDogStats.successRate;
                    document.getElementById('scrapingDogCost').textContent = '$' + stats.scrapingDogStats.totalCost.toFixed(2);
                    document.getElementById('scrapingDogUsage').textContent = stats.scrapingDogUsageRate;
                }
            } catch (error) {
                console.error('Error loading API stats:', error);
            }
        }

        function updateStats() {
            let totalActive = 0;
            let redCount = 0;
            let yellowCount = 0;
            let resolvedCount = 0;
            
            // Count alerts from the uniqueAlerts array that's populated in loadActiveAlerts
            if (window.uniqueAlerts && Array.isArray(window.uniqueAlerts)) {
                window.uniqueAlerts.forEach(alert => {
                    if (!alert.resolved) {
                        totalActive++;
                        if (alert.alert_level === 'RED') {
                            redCount++;
                        } else if (alert.alert_level === 'YELLOW') {
                            yellowCount++;
                        }
                    }
                });
            }
            
            // Note: We don't have resolved alerts in the current view, so it stays 0
            // If you want to track resolved alerts, we'd need to fetch them separately
            
            document.getElementById('totalAlerts').textContent = totalActive;
            document.getElementById('resolvedAlerts').textContent = resolvedCount;
            document.getElementById('yellowAlerts').textContent = yellowCount;
            document.getElementById('redAlerts').textContent = redCount;
        }

        function renderSites() {
            const container = document.getElementById('sitesList');
            const loading = document.getElementById('sitesLoading');
            const emptyState = document.getElementById('emptyState');
            
            loading.classList.remove('active');
            
            if (profiles.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            container.innerHTML = profiles.map(profile => {
                // Check if profile is pending approval
                if (profile.status === 'pending') {
                    return `
                        <div class="col-lg-6 mb-3">
                            <div class="status-card status-pending">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5>${profile.dealer_name}</h5>
                                        <p class="text-muted mb-2">${profile.website_url}</p>
                                        <p class="mb-1">
                                            <span class="status-indicator pending"></span>
                                            <strong>PENDING APPROVAL</strong>
                                        </p>
                                        <p class="mb-0"><small>Requested by: ${profile.requested_by || 'Unknown'}</small></p>
                                        <p class="mb-0"><small>Date: ${new Date(profile.created_at).toLocaleDateString()}</small></p>
                                    </div>
                                    <div class="text-warning">
                                        <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Determine the display status based on state
                let status = profile.overall_status;
                let displayStatus = status;
                
                if (!status || status === 'UNKNOWN') {
                    if (!profile.check_timestamp) {
                        displayStatus = 'PENDING CHECK';
                    } else {
                        displayStatus = 'MONITORING ACTIVE';
                    }
                }
                
                const statusClass = (status || 'unknown').toLowerCase();
                const lastCheck = profile.check_timestamp ? 
                    new Date(profile.check_timestamp).toLocaleString() : 
                    'Checking...';
                
                const issues = profile.issues_found ? 
                    (typeof profile.issues_found === 'string' ? 
                        JSON.parse(profile.issues_found) : profile.issues_found) : [];
                
                return `
                    <div class="col-lg-6 mb-3">
                        <div class="status-card status-${statusClass}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5>${profile.dealer_name}</h5>
                                    <p class="text-muted mb-2">${profile.website_url}</p>
                                    <p class="mb-1">
                                        <span class="status-indicator ${statusClass}"></span>
                                        <strong>${displayStatus}</strong>
                                    </p>
                                    ${profile.response_time_ms ? 
                                        `<p class="mb-1"><small>Response: ${profile.response_time_ms}ms</small></p>` : ''}
                                    ${issues.length > 0 ? 
                                        `<p class="mb-1"><small>${issues.length} issue${issues.length > 1 ? 's' : ''} found</small></p>` : ''}
                                    <p class="text-muted mb-0"><small>Last check: ${lastCheck}</small></p>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="runCheck(${profile.id}, event)">
                                        <i class="bi bi-arrow-clockwise"></i> Check Now
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning ms-1" onclick="event.stopPropagation(); sendTestAlert(${profile.id}, event);" title="Send test notifications">
                                        <i class="bi bi-bell"></i> Test
                                    </button>
                                    ${currentUser && currentUser.isAdmin ? 
                                        `<button class="btn btn-sm btn-outline-danger ms-1" onclick="removeProfile(${profile.id}, '${profile.dealer_name}')">
                                            <i class="bi bi-trash"></i>
                                        </button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadActiveAlerts() {
            const container = document.getElementById('alertsList');
            const loading = document.getElementById('alertsLoading');
            
            loading.classList.add('active');
            
            try {
                // Load alerts for all profiles
                const alertPromises = profiles.map(p => 
                    axios.get(`/api/monitoring/alerts/${p.id}?resolved=false`)
                );
                
                const responses = await Promise.all(alertPromises);
                activeAlerts = responses.flatMap(r => r.data);
                
                // Filter for active alerts (RED and YELLOW, not resolved)
                const activeUnresolvedAlerts = activeAlerts.filter(a => !a.resolved && (a.alert_level === 'RED' || a.alert_level === 'YELLOW'));
                
                console.log('All alerts:', activeAlerts);
                console.log('Unresolved alerts:', activeUnresolvedAlerts);
                
                // Sort alerts by severity (RED first) and then by time
                const sortedAlerts = activeUnresolvedAlerts.sort((a, b) => {
                    // First sort by level
                    if (a.alert_level === 'RED' && b.alert_level !== 'RED') return -1;
                    if (b.alert_level === 'RED' && a.alert_level !== 'RED') return 1;
                    // Then by time (newest first)
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                
                // Deduplicate alerts based on profile_id, alert_type, and alert_level
                const alertMap = new Map();
                sortedAlerts.forEach(alert => {
                    const key = `${alert.profile_id}_${alert.alert_type}_${alert.alert_level}`;
                    if (!alertMap.has(key)) {
                        alertMap.set(key, alert);
                    } else {
                        // Keep the most recent alert
                        const existing = alertMap.get(key);
                        if (new Date(alert.created_at) > new Date(existing.created_at)) {
                            alertMap.set(key, alert);
                        }
                    }
                });
                
                const uniqueAlerts = Array.from(alertMap.values());
                
                // Store uniqueAlerts globally for stats
                window.uniqueAlerts = uniqueAlerts;
                
                console.log('Active alerts loaded:', activeAlerts.length);
                console.log('Unique alerts by type:', uniqueAlerts);
                
                loading.classList.remove('active');
                
                // Update stats after loading alerts
                updateStats();
                
                if (uniqueAlerts.length === 0) {
                    container.innerHTML = `
                        <div class="p-4 text-center text-muted">
                            <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                            <p class="mb-0">No active alerts - All systems operational!</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Website</th>
                                <th>Alert</th>
                                <th>Level</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${uniqueAlerts.map(alert => {
                                const profile = profiles.find(p => p.id === alert.profile_id);
                                const level = alert.alert_level.toLowerCase();
                                const firstSeen = new Date(alert.created_at).toLocaleString();
                                const lastSeen = alert.last_seen ? new Date(alert.last_seen).toLocaleString() : null;
                                
                                return `
                                    <tr>
                                        <td>${profile ? profile.dealer_name : 'Unknown'}</td>
                                        <td>${alert.alert_message}</td>
                                        <td><span class="alert-badge ${level}">${alert.alert_level}</span></td>
                                        <td>
                                            <small>First: ${firstSeen}</small>
                                            ${lastSeen ? `<br><small>Last: ${lastSeen}</small>` : ''}
                                        </td>
                                        <td>
                                            ${!alert.acknowledged ? 
                                                `<button class="btn btn-sm btn-outline-primary" onclick="acknowledgeAlert(${alert.id})">
                                                    Acknowledge
                                                </button>` : 
                                                `<button class="btn btn-sm btn-outline-success" onclick="resolveAlert(${alert.id})">
                                                    Resolve
                                                </button>`
                                            }
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                
            } catch (error) {
                console.error('Error loading alerts:', error);
                loading.classList.remove('active');
            }
        }

        function showAddProfileModal() {
            const modal = new bootstrap.Modal(document.getElementById('addProfileModal'));
            modal.show();
        }

        let isAddingProfile = false;
        
        async function addProfile() {
            if (isAddingProfile) {
                console.log('Already adding profile, ignoring duplicate request');
                return;
            }
            
            const form = document.getElementById('addProfileForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            isAddingProfile = true;
            
            const data = {
                dealer_id: Date.now().toString(), // Generate unique ID
                dealer_name: document.getElementById('dealerName').value,
                website_url: document.getElementById('websiteUrl').value,
                contact_email: document.getElementById('contactEmail').value,
                alert_email: document.getElementById('alertEmail').value || document.getElementById('contactEmail').value,
                alert_phone: '', // No SMS support
                alert_preferences: {
                    email: true, // Always enable email
                    sms: false  // SMS disabled
                },
                check_frequency: 59, // Default frequency set by admin
                // Add approval workflow fields
                status: currentUser.isAdmin ? 'approved' : 'pending',
                requested_by: currentUser.username || currentUser.email
            };
            
            try {
                await axios.post('/api/monitoring/profiles', data);
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('addProfileModal')).hide();
                
                // Clear form
                form.reset();
                
                // Reload dashboard
                loadDashboard();
                
                // Show success message
                if (currentUser.isAdmin) {
                    alert('Website added successfully! Monitoring will begin shortly.');
                } else {
                    alert('Monitoring request submitted successfully! Your request will be reviewed by an administrator.');
                }
                
            } catch (error) {
                console.error('Error adding profile:', error);
                if (error.response) {
                    console.error('Response status:', error.response.status);
                    console.error('Response data:', error.response.data);
                    if (error.response.status === 403) {
                        alert('Access denied. Please make sure you are logged in as admin.');
                    } else {
                        alert(`Failed to add website: ${error.response.data.error || 'Unknown error'}`);
                    }
                } else {
                    alert('Failed to add website. Please try again.');
                }
            } finally {
                isAddingProfile = false;
            }
        }

        async function runCheck(profileId, event) {
            event.stopPropagation();
            
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;
            
            try {
                await axios.post(`/api/monitoring/check/${profileId}`);
                
                // Reload dashboard
                await loadDashboard();
                
            } catch (error) {
                console.error('Error running check:', error);
                alert('Failed to run check. Please try again.');
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        async function acknowledgeAlert(alertId) {
            try {
                await axios.put(`/api/monitoring/alerts/${alertId}/acknowledge`, {
                    acknowledged_by: 'Dashboard User'
                });
                
                // Reload alerts
                await loadActiveAlerts();
                
            } catch (error) {
                console.error('Error acknowledging alert:', error);
            }
        }

        async function resolveAlert(alertId) {
            try {
                await axios.put(`/api/monitoring/alerts/${alertId}/resolve`);
                
                // Reload alerts
                await loadActiveAlerts();
                
            } catch (error) {
                console.error('Error resolving alert:', error);
            }
        }

        function viewDetails(profileId) {
            // Navigate to detailed view (to be implemented)
            // Commenting out for now since details page doesn't exist
            // window.location.href = `/monitoring/details/${profileId}`;
            console.log('Details view not yet implemented for profile:', profileId);
        }

        function refreshDashboard() {
            loadDashboard();
        }
        
        async function sendTestAlert(profileId, event) {
            event.stopPropagation();
            
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;
            
            try {
                const response = await axios.post(`/api/monitoring/test-alert/${profileId}`);
                
                // Show appropriate message based on what happened
                if (response.data.emailEnabled || response.data.smsEnabled) {
                    if (response.data.success) {
                        // Actually sent notifications
                        alert(`Test notifications sent!\n\n${response.data.message}`);
                    } else {
                        // Settings not configured on server
                        alert(`Notification Setup Required\n\n${response.data.message}\n\nSee GMAIL-SETUP-GUIDE.md for instructions.`);
                    }
                } else {
                    // No notifications enabled in profile
                    alert('No notifications enabled for this profile.\n\nPlease enable Email or SMS alerts in the profile settings.');
                }
                
            } catch (error) {
                console.error('Error sending test alert:', error);
                alert('Failed to send test notifications. Please ensure email/SMS settings are configured.');
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        async function toggleMonitoring(profileId, currentStatus) {
            try {
                const newStatus = !currentStatus;
                await axios.put(`/api/monitoring/profiles/${profileId}`, {
                    monitoring_enabled: newStatus
                });
                
                await loadDashboard();
                
                const message = newStatus ? 'Monitoring resumed' : 'Monitoring paused';
                alert(message);
                
            } catch (error) {
                console.error('Error toggling monitoring:', error);
                alert('Failed to update monitoring status');
            }
        }

        async function removeProfile(profileId, dealerName) {
            if (!confirm(`Are you sure you want to remove ${dealerName} from monitoring?\n\nThis will delete all monitoring history.`)) {
                return;
            }
            
            try {
                const response = await axios.delete(`/api/monitoring/profiles/${profileId}`);
                
                await loadDashboard();
                
                alert(`${dealerName} removed from monitoring`);
                
            } catch (error) {
                console.error('Error removing profile:', error);
                if (error.response) {
                    console.error('Error response data:', error.response.data);
                    console.error('Error status:', error.response.status);
                    
                    // Try to extract the actual error message
                    let errorMessage = 'Unknown error';
                    if (error.response.data && error.response.data.error) {
                        errorMessage = error.response.data.error;
                    } else if (error.response.data && typeof error.response.data === 'string') {
                        errorMessage = error.response.data;
                    }
                    
                    if (error.response.status === 403) {
                        alert('Admin access required to delete profiles');
                    } else if (error.response.status === 500) {
                        alert(`Server error: ${errorMessage}\n\nPlease check server logs.`);
                    } else {
                        alert(`Failed to remove profile: ${errorMessage}`);
                    }
                } else {
                    alert('Failed to remove profile - network error');
                }
            }
        }
        
        function exportReport() {
            // Create export data
            const exportData = {
                exportDate: new Date().toLocaleString(),
                totalSites: profiles.length,
                statusSummary: {
                    green: profiles.filter(p => p.overall_status === 'GREEN').length,
                    yellow: profiles.filter(p => p.overall_status === 'YELLOW').length,
                    red: profiles.filter(p => p.overall_status === 'RED').length
                },
                sites: profiles.map(p => ({
                    name: p.dealer_name,
                    url: p.website_url,
                    status: p.overall_status || 'UNKNOWN',
                    lastCheck: p.check_timestamp,
                    responseTime: p.response_time_ms,
                    issues: p.issues_found
                })),
                activeAlerts: activeAlerts.map(a => ({
                    site: profiles.find(p => p.id === a.profile_id)?.dealer_name || 'Unknown',
                    level: a.alert_level,
                    message: a.alert_message,
                    time: a.created_at,
                    acknowledged: a.acknowledged
                }))
            };
            
            // Create CSV content
            let csv = 'Auto Audit Pro - Website Monitoring Report\n';
            csv += `Export Date: ${exportData.exportDate}\n\n`;
            
            csv += 'SUMMARY\n';
            csv += `Total Sites Monitored,${exportData.totalSites}\n`;
            csv += `Green (All Good),${exportData.statusSummary.green}\n`;
            csv += `Yellow (Warnings),${exportData.statusSummary.yellow}\n`;
            csv += `Red (Critical),${exportData.statusSummary.red}\n\n`;
            
            csv += 'MONITORED WEBSITES\n';
            csv += 'Dealership,Website,Status,Last Check,Response Time (ms),Issues\n';
            exportData.sites.forEach(site => {
                const issues = Array.isArray(site.issues) ? site.issues.length : 0;
                csv += `"${site.name}","${site.url}","${site.status}","${site.lastCheck || 'Never'}","${site.responseTime || 'N/A'}",${issues}\n`;
            });
            
            if (exportData.activeAlerts.length > 0) {
                csv += '\nACTIVE ALERTS\n';
                csv += 'Site,Level,Message,Time,Acknowledged\n';
                exportData.activeAlerts.forEach(alert => {
                    csv += `"${alert.site}","${alert.level}","${alert.message}","${alert.time}",${alert.acknowledged ? 'Yes' : 'No'}\n`;
                });
            }
            
            // Download CSV file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `monitoring_report_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>