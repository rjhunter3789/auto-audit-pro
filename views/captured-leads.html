<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captured Leads - Auto Audit Pro Admin</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 1;
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2a5298;
            margin: 10px 0;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .filters input, .filters select {
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            float: right;
        }
        
        .export-btn:hover {
            background: #218838;
        }
        
        .leads-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            color: #333;
            font-weight: bold;
            text-align: left;
            padding: 15px;
            border-bottom: 2px solid #dee2e6;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            background: #e9ecef;
            color: #495057;
        }
        
        .role-badge.owner {
            background: #28a745;
            color: white;
        }
        
        .role-badge.gm {
            background: #17a2b8;
            color: white;
        }
        
        .role-badge.marketing {
            background: #ffc107;
            color: #212529;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #2a5298;
            text-decoration: none;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .btn-email {
            background: #2a5298;
            color: white;
        }
        
        .btn-email:hover {
            background: #1e3c72;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/admin-dashboard" class="back-link">‚Üê Back to Admin Dashboard</a>
        
        <div class="header">
            <h1>Captured Leads</h1>
            <p>Manage leads captured through the Auto Audit Pro Suite access form</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>Total Leads</h3>
                <div class="number" id="totalLeads">0</div>
            </div>
            <div class="stat-card">
                <h3>This Week</h3>
                <div class="number" id="weekLeads">0</div>
            </div>
            <div class="stat-card">
                <h3>This Month</h3>
                <div class="number" id="monthLeads">0</div>
            </div>
            <div class="stat-card">
                <h3>Conversion Rate</h3>
                <div class="number" id="conversionRate">0%</div>
            </div>
        </div>
        
        <div class="filters">
            <input type="text" id="searchInput" placeholder="Search by name, email, or dealership...">
            <select id="roleFilter">
                <option value="">All Roles</option>
                <option value="owner">Dealer Owner/Principal</option>
                <option value="gm">General Manager</option>
                <option value="marketing">Marketing Director</option>
                <option value="internet">Internet/Digital Manager</option>
                <option value="vendor">Vendor/Partner</option>
                <option value="other">Other</option>
            </select>
            <select id="dateFilter">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
            </select>
            <button class="export-btn" onclick="exportLeads()">Export to CSV</button>
        </div>
        
        <div class="leads-table">
            <div class="loading" id="loading">Loading leads...</div>
            <table id="leadsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Dealership</th>
                        <th>Contact Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Role</th>
                        <th>Website</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="leadsTableBody">
                </tbody>
            </table>
            <div class="no-data" id="noData" style="display: none;">
                No leads captured yet. Share the suite URL to start capturing leads!
            </div>
        </div>
    </div>
    
    <script>
        let allLeads = [];
        
        async function loadLeads() {
            try {
                const response = await fetch('/api/captured-leads');
                if (!response.ok) throw new Error('Failed to load leads');
                
                allLeads = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                if (allLeads.length > 0) {
                    document.getElementById('leadsTable').style.display = 'table';
                    updateStats();
                    renderLeads();
                } else {
                    document.getElementById('noData').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading leads:', error);
                document.getElementById('loading').innerHTML = 'Error loading leads. Please try again.';
            }
        }
        
        function updateStats() {
            document.getElementById('totalLeads').textContent = allLeads.length;
            
            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            const weekLeads = allLeads.filter(lead => new Date(lead.capturedAt) > weekAgo).length;
            const monthLeads = allLeads.filter(lead => new Date(lead.capturedAt) > monthAgo).length;
            
            document.getElementById('weekLeads').textContent = weekLeads;
            document.getElementById('monthLeads').textContent = monthLeads;
            
            // Simple conversion rate (leads that provided phone number)
            const withPhone = allLeads.filter(lead => lead.phone).length;
            const conversionRate = allLeads.length > 0 ? Math.round((withPhone / allLeads.length) * 100) : 0;
            document.getElementById('conversionRate').textContent = conversionRate + '%';
        }
        
        function renderLeads(leadsToRender = allLeads) {
            const tbody = document.getElementById('leadsTableBody');
            tbody.innerHTML = '';
            
            leadsToRender.forEach(lead => {
                const row = tbody.insertRow();
                
                const date = new Date(lead.capturedAt);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${lead.dealershipName}</td>
                    <td>${lead.contactName}</td>
                    <td>${lead.email}</td>
                    <td>${lead.phone || '-'}</td>
                    <td><span class="role-badge ${lead.role}">${getRoleLabel(lead.role)}</span></td>
                    <td><a href="${lead.websiteUrl}" target="_blank">${new URL(lead.websiteUrl).hostname}</a></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-small btn-email" onclick="emailLead('${lead.email}')">Email</button>
                            <button class="btn-small btn-delete" onclick="deleteLead('${lead.id}')">Delete</button>
                        </div>
                    </td>
                `;
            });
        }
        
        function getRoleLabel(role) {
            const roleMap = {
                'owner': 'Dealer Owner/Principal',
                'gm': 'General Manager',
                'marketing': 'Marketing Director',
                'internet': 'Internet/Digital Manager',
                'vendor': 'Vendor/Partner',
                'other': 'Other'
            };
            return roleMap[role] || role;
        }
        
        function emailLead(email) {
            window.location.href = `mailto:${email}`;
        }
        
        async function deleteLead(leadId) {
            if (!confirm('Are you sure you want to delete this lead?')) return;
            
            try {
                const response = await fetch(`/api/captured-leads/${leadId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadLeads();
                } else {
                    alert('Failed to delete lead');
                }
            } catch (error) {
                console.error('Error deleting lead:', error);
                alert('Error deleting lead');
            }
        }
        
        function exportLeads() {
            if (allLeads.length === 0) {
                alert('No leads to export');
                return;
            }
            
            // Create CSV content
            const headers = ['Date', 'Dealership', 'Contact Name', 'Email', 'Phone', 'Role', 'Website'];
            const rows = allLeads.map(lead => [
                new Date(lead.capturedAt).toLocaleString(),
                lead.dealershipName,
                lead.contactName,
                lead.email,
                lead.phone || '',
                getRoleLabel(lead.role),
                lead.websiteUrl
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auto-audit-pro-leads-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Filter functionality
        document.getElementById('searchInput').addEventListener('input', filterLeads);
        document.getElementById('roleFilter').addEventListener('change', filterLeads);
        document.getElementById('dateFilter').addEventListener('change', filterLeads);
        
        function filterLeads() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;
            
            let filtered = allLeads;
            
            // Search filter
            if (searchTerm) {
                filtered = filtered.filter(lead => 
                    lead.dealershipName.toLowerCase().includes(searchTerm) ||
                    lead.contactName.toLowerCase().includes(searchTerm) ||
                    lead.email.toLowerCase().includes(searchTerm)
                );
            }
            
            // Role filter
            if (roleFilter) {
                filtered = filtered.filter(lead => lead.role === roleFilter);
            }
            
            // Date filter
            if (dateFilter) {
                const now = new Date();
                let startDate;
                
                switch (dateFilter) {
                    case 'today':
                        startDate = new Date(now.setHours(0, 0, 0, 0));
                        break;
                    case 'week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case 'month':
                        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                    case 'quarter':
                        startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                        break;
                }
                
                if (startDate) {
                    filtered = filtered.filter(lead => new Date(lead.capturedAt) > startDate);
                }
            }
            
            renderLeads(filtered);
        }
        
        // Load leads on page load
        loadLeads();
    </script>
</body>
</html>