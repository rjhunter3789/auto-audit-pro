VOICE INTERRUPTION FIX
======================

1. SSH into your server:
   ssh root@146.190.39.214

2. Navigate to the project:
   cd /var/www/smart-doc-v2

3. Open the file to edit:
   nano templates/voice-handsfree.html

4. Find line 252-290 (the monitorAudioLevels function)

5. Replace the entire monitorAudioLevels function with this:

        function monitorAudioLevels() {
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            let silenceDuration = 0;
            const SILENCE_THRESHOLD = 30;
            const SILENCE_DURATION = 2000; // 2 seconds of silence
            
            function checkAudioLevel() {
                if (!isListening && !currentAudio) {
                    requestAnimationFrame(checkAudioLevel);
                    return;
                }
                
                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                
                // Update visualizer when listening
                if (isListening) {
                    const bars = visualizer.querySelectorAll('.audio-bar');
                    bars.forEach((bar, i) => {
                        const height = Math.min(40, dataArray[i * 50] / 3);
                        bar.style.height = height + 'px';
                    });
                    
                    if (average < SILENCE_THRESHOLD) {
                        silenceDuration += 100;
                        const progress = Math.min(100, (silenceDuration / SILENCE_DURATION) * 100);
                        silenceProgress.style.width = progress + '%';
                        
                        if (silenceDuration >= SILENCE_DURATION) {
                            stopListening();
                        }
                    } else {
                        silenceDuration = 0;
                        silenceProgress.style.width = '0%';
                    }
                }
                
                // Check for voice interruption while audio is playing
                if (currentAudio && !currentAudio.paused && !isListening) {
                    if (average > 30) { // Voice detected
                        currentAudio.pause();
                        currentAudio = null;
                        interruptNote.style.display = 'none';
                        status.textContent = 'Interrupted - tap to speak';
                    }
                }
                
                requestAnimationFrame(checkAudioLevel);
            }
            
            checkAudioLevel();
        }

6. Also add this variable at line 210 (after let currentAudio = null;):
   let voiceInterruptionStream = null;

7. Save and exit:
   Ctrl+X, Y, Enter

8. Restart the app:
   pm2 restart smart-doc-v2

9. Test at:
   https://smartdoc.autoauditpro.io/voice-handsfree

The fix ensures audioContext and analyser are checked before use and properly monitors for voice interruption while audio is playing.