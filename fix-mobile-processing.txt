FIX MOBILE PROCESSING STUCK ISSUE
=================================

1. SSH to server:
   ssh root@146.190.39.214
   cd /var/www/smart-doc-v2
   nano templates/voice-handsfree.html

2. Find the processAudio function (around line 354):
   Ctrl+_ 
   354

3. Look for the finally block (around line 407-412):
   } finally {
       isProcessing = false;
       micButton.classList.remove('processing');
       micIcon.textContent = 'ðŸŽ¤';
       status.textContent = 'Tap to speak';
   }

4. REMOVE or comment out this entire finally block

5. Instead, add isProcessing = false in the right places:

   A. After successful response (around line 400):
      currentAudio.onended = () => {
          currentAudio = null;
          interruptNote.style.display = 'none';
          isProcessing = false;  // ADD THIS
          micButton.classList.remove('processing');
          micIcon.textContent = 'ðŸŽ¤';
          status.textContent = 'Tap to speak';
      };

   B. In the error handler (around line 409):
      } else {
          status.textContent = 'Error: ' + result.error;
          isProcessing = false;  // ADD THIS
          micButton.classList.remove('processing');
          micIcon.textContent = 'ðŸŽ¤';
      }

   C. In the catch block (around line 411):
      } catch (error) {
          status.textContent = 'Error: ' + error.message;
          isProcessing = false;  // ADD THIS
          micButton.classList.remove('processing');
          micIcon.textContent = 'ðŸŽ¤';
      }

6. Also check if there's no audio response case:
   if (aiResult.success) {
       addMessage(aiResult.response, 'assistant-message');
       
       if (aiResult.audio_url) {
           // existing audio code...
       } else {
           // No audio response
           isProcessing = false;
           micButton.classList.remove('processing');
           micIcon.textContent = 'ðŸŽ¤';
           status.textContent = 'Tap to speak';
       }
   }

7. Save and exit:
   Ctrl+X, Y, Enter

8. Restart:
   pm2 restart smart-doc-v2

This ensures isProcessing is ONLY set to false AFTER the audio plays or an error occurs, not immediately after recording stops.